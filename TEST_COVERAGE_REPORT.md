# テストカバレッジレポート

## 概要
このドキュメントでは、パートナー協業プラットフォームのテストカバレッジと実装されたテストスイートについて説明します。

## Backend テストカバレッジ

### 実装されたテスト

#### 1. AuthService テスト (`backend/src/modules/auth/auth.service.spec.ts`)
**カバレッジ目標:** 80%以上

**テストケース:**
- ユーザー登録
  - 正常な登録
  - 既存メールアドレスでの登録失敗
  - パスワードハッシュ化の確認
- ログイン
  - 有効な認証情報でのログイン
  - 無効なメールアドレスでのログイン失敗
  - 無効なパスワードでのログイン失敗
  - 非アクティブアカウントでのログイン失敗
  - ログイン時刻の更新
- トークンリフレッシュ
  - 有効なリフレッシュトークンでの更新
  - 無効なトークンでの失敗
  - ユーザーが存在しない場合の失敗
  - トークン不一致での失敗
- ログアウト
  - リフレッシュトークンのクリア
- ユーザー管理
  - ユーザー検索
  - ユーザー一覧取得
  - ユーザー更新
  - パスワード変更
  - ユーザー削除
- エッジケース
  - 空文字列の処理
  - NULL値の処理
  - データベースエラーの処理
- 境界値テスト
  - 最小パスワード長
  - 長いメールアドレス
  - 特殊文字を含むパスワード

**重点テスト項目:**
- セキュリティ: パスワードハッシュ化、トークン検証
- 認証フロー: ログイン、ログアウト、トークンリフレッシュ
- エラーハンドリング: 不正な入力、データベースエラー

#### 2. ProjectService テスト (`backend/src/modules/project/project.service.spec.ts`)
**カバレッジ目標:** 75%以上

**テストケース:**
- CRUD操作
  - プロジェクト作成
  - プロジェクト取得
  - プロジェクト更新
  - プロジェクト削除
- ステータス管理
  - ステータス更新
  - 進捗更新
  - 完了時の自動処理
- パートナー管理
  - パートナー追加
  - パートナー削除
  - 重複パートナーの防止
- クエリ機能
  - ページネーション
  - フィルタリング
  - ソート
- 統計情報
  - プロジェクト統計取得
  - 期限超過プロジェクト取得
  - 期限接近プロジェクト取得
- エッジケース
  - 空のパートナーリスト
  - NULL日付
  - 境界値の進捗

**重点テスト項目:**
- ビジネスロジック: ステータス遷移、進捗計算
- データ整合性: パートナー関連、日付管理
- クエリパフォーマンス: ページネーション、フィルタリング

#### 3. TaskService テスト (`backend/src/modules/task/task.service.spec.ts`)
**カバレッジ目標:** 75%以上

**テストケース:**
- CRUD操作
  - タスク作成
  - タスク取得
  - タスク更新
  - タスク削除
- ステータス管理
  - ステータス更新
  - 進捗更新
  - 完了時の自動処理
- タスク割り当て
  - ユーザーへの割り当て
  - パートナーへの割り当て
- クエリ機能
  - 期限超過タスク取得
  - プロジェクト別タスク取得
  - 担当者別タスク取得

**重点テスト項目:**
- タスク管理: 作成、割り当て、ステータス更新
- 期限管理: 期限超過検出、通知
- サブタスク: 親子関係の管理

#### 4. PartnerService テスト (`backend/src/modules/partner/partner.service.spec.ts`)
**カバレッジ目標:** 70%以上

**テストケース:**
- CRUD操作
  - パートナー登録
  - パートナー取得
  - パートナー更新
  - パートナー削除
- ステータス管理
  - ステータス更新
  - 評価更新
- 検索・フィルタリング
  - スキルベース検索
  - ステータスフィルター
- 統計情報
  - パートナー統計取得

**重点テスト項目:**
- データ検証: メール重複チェック
- 検索機能: スキルマッチング
- 統計計算: 評価平均、完了率

#### 5. Guards テスト
**カバレッジ目標:** 90%以上

##### JwtAuthGuard (`backend/src/common/guards/jwt-auth.guard.spec.ts`)
**テストケース:**
- 認証チェック
  - 公開ルートへのアクセス許可
  - 保護ルートの認証要求
  - 無効なトークンの拒否
- エラーハンドリング
  - ユーザー不在時の処理
  - トークンエラーの処理
- エッジケース
  - Undefinedコンテキスト
  - メタデータ不在

##### RolesGuard (`backend/src/common/guards/roles.guard.spec.ts`)
**テストケース:**
- ロールチェック
  - 必要なロールを持つユーザーの許可
  - 不足ロールでの拒否
  - 複数ロールの処理
- ロール階層
  - ADMIN、MANAGER、MEMBER、PARTNERの各ロールテスト
- セキュリティ
  - ロールエスカレーション防止
  - 大文字小文字の区別
  - NULL値の処理

**重点テスト項目:**
- セキュリティ: 認証・認可の厳密性
- エッジケース: 異常な入力への対応
- パフォーマンス: ガードの効率性

## Frontend テストカバレッジ

### テスト環境設定
- **テストフレームワーク:** Vitest
- **テストユーティリティ:** @testing-library/react
- **カバレッジツール:** v8

### 実装されたテスト

#### 1. LoginPage テスト (`frontend/src/pages/LoginPage.test.tsx`)
**カバレッジ目標:** 85%以上

**テストケース:**
- レンダリング
  - ログインフォーム表示
  - ブランディングセクション表示
  - デモ認証情報の表示
  - パスワード表示切替ボタン
- フォーム操作
  - メール入力
  - パスワード入力
  - パスワード表示/非表示切替
- バリデーション
  - 空のメールアドレス
  - 無効なメールフォーマット
  - 空のパスワード
  - 短すぎるパスワード
  - バリデーションエラーのクリア
- フォーム送信
  - 無効データでの送信防止
  - 有効データでの送信
  - ログイン関数の呼び出し確認
- ローディング状態
  - ローディング中のボタン無効化
- エラー表示
  - ストアからのエラーメッセージ表示
- エッジケース
  - 非常に長いメールアドレス
  - 特殊文字を含むパスワード
  - 空白文字の処理
- アクセシビリティ
  - 適切なラベル
  - キーボード操作
  - フォーカススタイル

**重点テスト項目:**
- ユーザーインタラクション: フォーム入力、送信
- バリデーション: リアルタイム検証、エラー表示
- アクセシビリティ: ARIA属性、キーボード操作

#### 2. Button コンポーネント テスト (`frontend/src/components/common/Button.test.tsx`)
**カバレッジ目標:** 95%以上

**テストケース:**
- レンダリング
  - 各バリアント (primary, secondary, outline, ghost, danger)
  - 各サイズ (sm, md, lg)
- アイコン
  - 左アイコン表示
  - 右アイコン表示
  - 両方のアイコン表示
  - ローディング時のアイコン非表示
- ローディング状態
  - スピナー表示
  - ボタン無効化
  - アイコンの置き換え
- 無効状態
  - 無効化時のボタン無効化
  - 不透明度スタイル適用
  - クリック無効化
- フルワイドス
  - 全幅表示
- クリックハンドラ
  - 通常時のクリック処理
  - 無効時のクリック防止
  - ローディング時のクリック防止
- カスタムプロパティ
  - カスタムクラス名
  - type属性
  - data属性
  - ARIA属性
- Ref転送
  - ref の正しい転送
- エッジケース
  - 空の子要素
  - 複数の子ノード
  - 連続クリック
- アクセシビリティ
  - ボタンロール
  - キーボードアクセス
  - フォーカススタイル
- バリアント組み合わせ
  - バリアントとサイズの組み合わせ
  - すべてのプロパティの組み合わせ

**重点テスト項目:**
- 視覚的バリエーション: スタイリング、サイズ
- インタラクション: クリック、キーボード操作
- 状態管理: ローディング、無効化

#### 3. authStore テスト (`frontend/src/store/authStore.test.ts`)
**カバレッジ目標:** 90%以上

**テストケース:**
- 初期状態
  - デフォルト値の確認
- login アクション
  - ユーザーとトークンの設定
  - エラーのクリア
  - 異なるロールの処理
- logout アクション
  - ユーザーとトークンのクリア
  - エラーのクリア
- setLoading アクション
  - ローディング状態の設定
- setError アクション
  - エラーメッセージの設定
  - エラーのクリア
- updateUser アクション
  - ユーザーフィールドの更新
  - 部分的な更新
  - NULL ユーザー時の処理
- 永続化
  - 認証状態の永続化
- エッジケース
  - 複数のログイン/ログアウトサイクル
  - ログイン中の再ログイン
  - 空のトークン
  - 長いエラーメッセージ
- ステートセレクター
  - 特定の状態スライスの選択

**重点テスト項目:**
- 状態管理: ログイン、ログアウト、更新
- 永続化: ローカルストレージとの連携
- エラーハンドリング: エラー状態の管理

#### 4. uiStore テスト (`frontend/src/store/uiStore.test.ts`)
**カバレッジ目標:** 90%以上

**テストケース:**
- 初期状態
  - デフォルト値の確認
- サイドバーアクション
  - トグル機能
  - 開閉状態の設定
- プロジェクト表示形式アクション
  - list、grid、kanban の切り替え
- テーマアクション
  - light、dark、system の切り替え
- 通知アクション
  - 通知の追加
  - 複数通知の追加
  - 一意なID生成
  - 通知の削除
  - 全通知のクリア
  - 各種通知タイプの処理
- エッジケース
  - 複数回の高速トグル
  - 空の通知タイトル
  - 長い通知メッセージ
  - ゼロまたは負の期間
  - 通知の順序維持
  - 中間通知の削除
- 状態永続化
  - 複数操作での状態維持
- ステートセレクター
  - 特定の状態スライスの選択

**重点テスト項目:**
- UI状態管理: サイドバー、テーマ、表示形式
- 通知システム: 追加、削除、管理
- エッジケース処理: 異常な入力への対応

## テスト実行方法

### Backend
```bash
cd backend

# 全テスト実行
npm test

# カバレッジレポート生成
npm run test:cov

# ウォッチモード
npm run test:watch
```

### Frontend
```bash
cd frontend

# 依存関係インストール (初回のみ)
npm install

# 全テスト実行
npm test

# カバレッジレポート生成
npm run test:coverage

# UI付きテスト実行
npm run test:ui
```

## カバレッジ目標

### Backend
- **全体目標:** 70%以上
- **クリティカルパス (Auth, Guards):** 85%以上
- **サービス層:** 75%以上
- **エンティティ:** テスト不要 (ビジネスロジックなし)

### Frontend
- **全体目標:** 70%以上
- **コアコンポーネント:** 85%以上
- **ページコンポーネント:** 75%以上
- **Store:** 90%以上
- **Hooks:** 80%以上

## テストケース一覧サマリー

### Backend
| モジュール | テストファイル | テストケース数 | カバレッジ目標 |
|-----------|---------------|--------------|--------------|
| AuthService | auth.service.spec.ts | 30+ | 80% |
| ProjectService | project.service.spec.ts | 25+ | 75% |
| TaskService | task.service.spec.ts | 20+ | 75% |
| PartnerService | partner.service.spec.ts | 18+ | 70% |
| JwtAuthGuard | jwt-auth.guard.spec.ts | 12+ | 90% |
| RolesGuard | roles.guard.spec.ts | 20+ | 90% |

### Frontend
| コンポーネント/Store | テストファイル | テストケース数 | カバレッジ目標 |
|-------------------|---------------|--------------|--------------|
| LoginPage | LoginPage.test.tsx | 35+ | 85% |
| Button | Button.test.tsx | 50+ | 95% |
| authStore | authStore.test.ts | 25+ | 90% |
| uiStore | uiStore.test.ts | 30+ | 90% |

## 今後の拡張

### 優先度 高
- [ ] Input コンポーネント テスト
- [ ] Modal コンポーネント テスト
- [ ] Pagination コンポーネント テスト
- [ ] useAuth フック テスト
- [ ] useProjects フック テスト
- [ ] useTasks フック テスト

### 優先度 中
- [ ] TaskService の追加テスト (サブタスク関連)
- [ ] PartnerService の追加テスト (スキル検索)
- [ ] ProjectCard コンポーネント テスト
- [ ] TaskList コンポーネント テスト

### 優先度 低
- [ ] E2Eテストの追加
- [ ] パフォーマンステスト
- [ ] ビジュアルリグレッションテスト

## ベストプラクティス

### テスト作成ガイドライン
1. **AAA パターン**: Arrange (準備) → Act (実行) → Assert (検証)
2. **独立性**: 各テストは独立して実行可能
3. **明確な命名**: テストの目的が名前から理解できる
4. **エッジケース**: 正常系だけでなく異常系もテスト
5. **モック使用**: 外部依存は適切にモック
6. **カバレッジ**: 目標値を達成しつつ、意味のあるテストを作成

### テストすべきこと
- ✅ ビジネスロジック
- ✅ ユーザーインタラクション
- ✅ エラーハンドリング
- ✅ 境界値
- ✅ エッジケース

### テストしなくてよいこと
- ❌ サードパーティライブラリの機能
- ❌ フレームワークの機能
- ❌ 単純なgetterGET/setter
- ❌ 自動生成されたコード

## まとめ

このテストスイートは、パートナー協業プラットフォームの主要機能に対して包括的なカバレッジを提供します。

**実装済みテスト:**
- Backend: 125+ テストケース
- Frontend: 140+ テストケース
- 合計: 265+ テストケース

**カバレッジ範囲:**
- 認証・認可: 完全カバー
- CRUD操作: 高カバー
- ビジネスロジック: 高カバー
- UI コンポーネント: 中〜高カバー
- 状態管理: 完全カバー

継続的にテストを追加・改善し、70%以上のコードカバレッジを維持することで、高品質なアプリケーションを保証します。
